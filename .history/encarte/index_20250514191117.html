<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<body>
    <template>
  <section class="section-formulario" data-id="formulario">
    <div class="form-container">
      <div class="franquia-info">
        <div class="logo-container">
          <img
            src="https://abcdaconstrucao.my.site.com/clubedayfla/sfsites/c/cms/delivery/media/MCZ7TLAK2FZ5H5ZIQRF36NDRO464"
            alt="Logotema da Campanha do mês" width="140" height="auto" />
        </div>
        <h1>Cadastre-se e receba as ofertas do mês!</h1>
        <p>
          Sua chance de economizar em produtos de qualidade, com ofertas especiais na sua região.
        </p>
      </div>
      <div class="forms">
        <div class="form-title">
          <figure>
            <img if:true={isStep1}
              src="https://abcdaconstrucao.my.site.com/clubedayfla/sfsites/c/cms/delivery/media/MC5Y62MNEZFJGMPJMBS3EGVEBBCE"
              alt="Franquia ABC Miniatura" class="image-form" width="100" height="auto" />
            <img if:true={isStep2}
              src="https://abcdaconstrucao.my.site.com/clubedayfla/sfsites/c/cms/delivery/media/MC5Y62MNEZFJGMPJMBS3EGVEBBCE"
              alt="Franquia ABC Miniatura" class="image-form" width="100" height="auto" />
            <img if:true={isStep3}
              src="https://abcdaconstrucao.my.site.com/clubedayfla/sfsites/c/cms/delivery/media/MCVRWGAJ42NFFITBCCJLEOV4KKYE"
              alt="Check de Sucesso" class="check-form" width="80" height="80" />
          </figure>
          <p if:true={isStep1} class="titleStep1 forms-title">Ofertas exclusivas <br />na sua região</p>
          <p if:true={isStep2} class="titleStep2 forms-title">Cadastro rápido: Preencha com seus dados</p>
          <p if:true={isStep3} class="titleStep3 forms-title">É hora de economizar!</p>
          <p if:true={isStep1} class="subtitleStep1 forms-subtitle">Selecione sua localização para ver ofertas
            personalizadas</p>
          <p if:true={isStep2} class="subtitleStep2 forms-subtitle">Estamos quase lá! Preencha os campos abaixo</p>
          <p if:true={isStep3} class="subtitleStep3 forms-subtitle">Confira o catálogo de ofertas no email que você cadastrou e aproveite.<br />Seus dados foram enviados com sucesso e segurança.</p>
          <br />
          <div class="container-progress-bar">
            <div class="line-progress">
              <div class="progress-bar" if:true={isStep3} style="width:100%; background-color: #00A859;"></div>
              <div class="progress-bar" if:false={isStep3} lwc:dom="manual"></div>
            </div>
            <div class="progress-percent progress-success" if:true={isStep3}>100%</div>
            <div class="progress-percent" if:false={isStep3}>{progress}%</div>
          </div>
        </div>
        <form>
          <!-- Etapa 1 -->
          <div if:true={isStep1} class="formStep1">
            <div class="label-input-row">
              <div class="label-input">
                <label for="state">Estado *</label>
                <div class="select-custom">
                  <select name="state" id="state" required onchange={handleStateChange}>
                    <option value="" disabled selected>Selecione</option>
                    <template for:each={stateOptions} for:item="option">
                      <option key={option.value} value={option.value}>{option.label}</option>
                    </template>
                  </select>
                </div>
              </div>
              <div class="label-input">
                <label for="city">Cidade *</label>
                <div class="select-custom">
                  <select name="city" id="city" required onchange={handleCityChange} disabled={isCitySelectDisabled}>
                    <option value="" disabled selected>Selecione</option>
                    <template for:each={cityOptions} for:item="option">
                      <option key={option.value} value={option.value}>{option.label}</option>
                    </template>
                  </select>
                </div>
              </div>
            </div>
            <div class="label-input">
              <label for="guide_shop">Selecione a Guide Shop mais próxima de você *</label>
              <div class="select-custom">
                <select name="guide_shop" id="guide_shop" required onchange={handleGuideShopChange}
                  disabled={isGuideShopSelectDisabled}>
                  <option value="" disabled selected>Selecione</option>
                  <template for:each={guideShopOptions} for:item="option">
                    <option key={option.value} value={option.value}>{option.label}</option>
                  </template>
                </select>
              </div>
            </div>
            <div class="frame-botoes next-step-container">
              <button type="button" class={nextButtonStep1Class} disabled={isNextButtonStep1Disabled}
                onclick={handleNextStep}>
                AVANÇAR
              </button>
            </div>
          </div>

          <!-- Etapa 2 -->
          <div if:true={isStep2} class="formStep2">
            <div class="label-input-row">
              <div class="label-input">
                <label for="name">Nome *</label>
                <input type="text" name="name" id="name" placeholder="Digite seu nome" value={formData.name}
                  onchange={handleNameChange} required />
              </div>
              <div class="label-input">
                <label for="lastname">Sobrenome *</label>
                <input type="text" name="lastname" id="lastname" placeholder="Sobrenome" value={formData.lastname}
                  onchange={handleLastnameChange} required />
              </div>
            </div>
            <div class="label-input">
              <label for="tel">Telefone Whatsapp *</label>
              <input type="tel" name="tel" id="tel" placeholder="(xx) xxxxx-xxxx" value={formData.tel}
                onchange={handleTelChange} required />
            </div>
            <div class="label-input">
              <label for="email">E-mail *</label>
              <input type="email" name="email" id="email" placeholder="Digite seu e-mail" value={formData.email}
                onchange={handleEmailChange} required />
            </div>
            <div class="checkbox-group">
              <div class="checkbox-item">
                <input type="checkbox" id="privacyPolicy" name="privacyPolicy" checked={formData.privacyPolicy}
                  onchange={handlePrivacyPolicyChange} />
                <label for="privacyPolicy">
                  Eu concordo com a Política de Privacidade e autorizo o uso dos meus dados conforme descrito.
                </label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="marketingConsent" name="marketingConsent" checked={formData.marketingConsent}
                  onchange={handleMarketingConsentChange} />
                <label for="marketingConsent">
                  Concordo em receber E-mails, SMS e Whatsapp da ABC da Construção.
                </label>
              </div>
            </div>
            <div class="frame-botoes">
              <button type="button" class="botao-voltar-Step2" onclick={handlePreviousStep}>
                <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M15 10H5M5 10L10 15M5 10L10 5" stroke="#333333" stroke-width="1.5" stroke-linecap="round"
                    stroke-linejoin="round" />
                </svg>
              </button>
              <button type="button" class={nextButtonStep2Class} disabled={isNextButtonStep2Disabled}
                onclick={handleSubmitForm}>
                FINALIZAR
              </button>
            </div>
          </div>

          <!-- Etapa 3 -->
          <div if:true={isStep3} class="formStep3">
            <div class="frame-botoes success-buttons">
              <button class="botaoReset resetar-btn" type="button" onclick={resetForm}>
                <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path
                    d="M10 3.33325V1.66659L6.66667 4.99992L10 8.33325V6.66659C12.7583 6.66659 15 8.90825 15 11.6666C15 14.4249 12.7583 16.6666 10 16.6666C7.24167 16.6666 5 14.4249 5 11.6666H3.33333C3.33333 15.3499 6.31667 18.3333 10 18.3333C13.6833 18.3333 16.6667 15.3499 16.6667 11.6666C16.6667 7.98325 13.6833 4.99992 10 4.99992V3.33325Z"
                    fill="#333333" />
                </svg>
              </button>
              <button class="botaoOutrasGuideShops" type="button" onclick={resetForm}>Ver Guide Shops</button>
            </div>
          </div>
        </form>
      </div>
    </div>
    <!-- FOOTER -->
    <footer class="footer">
      <div class="footer-container">
        <div class="logo-box">
          <img
            src="https://abcdaconstrucao.my.site.com/clubedayfla/sfsites/c/cms/delivery/media/MCMP47Z7F55JAYDOZFLPWB2XOOA4"
            alt="Logo ABC da Construção" width="60" height="auto" />
        </div>
        <div class="footer-copyright">
          <p>© 2025 ABC DA CONSTRUÇÃO LTDA. Todos os direitos reservados.</p>
        </div>
        <div class="footer-slogan">
          <p>Tudo em acabamentos, tudo para você.</p>
        </div>
      </div>
    </footer>
  </section>
</template>
<script>
    import { LightningElement, track } from "lwc";

export default class LpEncarte extends LightningElement {
  @track formData = {
    state: "",
    city: "",
    guide_shop: "",
    name: "",
    lastname: "",
    email: "",
    tel: "",
    privacyPolicy: true,
    marketingConsent: true,
    firstName: "",
    lastName: "",
    idLead: "",
    recordtypeDevName: "Expansao",
    company: "ABC",
    company2: "ABC Expansão",
    owner: "00GbJ0000062OFjUAM",
    canalDeEntrada: "Landing Page Expansão",
  };

  @track currentStep = 1;
  @track progress = 0;
  @track validEmail = false;

  get stateOptions() {
    return [
      { label: "Selecione", value: "", disabled: true },
      { label: "AC", value: "AC" },
      { label: "AL", value: "AL" },
      { label: "AM", value: "AM" },
      { label: "AP", value: "AP" },
      { label: "BA", value: "BA" },
      { label: "CE", value: "CE" },
      { label: "DF", value: "DF" },
      { label: "ES", value: "ES" },
      { label: "GO", value: "GO" },
      { label: "MA", value: "MA" },
      { label: "MS", value: "MS" },
      { label: "MT", value: "MT" },
      { label: "MG", value: "MG" },
      { label: "PA", value: "PA" },
      { label: "PB", value: "PB" },
      { label: "PE", value: "PE" },
      { label: "PI", value: "PI" },
      { label: "PR", value: "PR" },
      { label: "RJ", value: "RJ" },
      { label: "RN", value: "RN" },
      { label: "RS", value: "RS" },
      { label: "RO", value: "RO" },
      { label: "RR", value: "RR" },
      { label: "SC", value: "SC" },
      { label: "SP", value: "SP" },
      { label: "SE", value: "SE" },
      { label: "TO", value: "TO" },
    ];
  }

  @track cityOptions = [{ label: "Selecione", value: "", disabled: true }];

  @track guideShopOptions = [{ label: "Selecione", value: "", disabled: true }];

  get isStep1() {
    return this.currentStep === 1;
  }

  get isStep2() {
    return this.currentStep === 2;
  }

  get isStep3() {
    return this.currentStep === 3;
  }

  get progressBarStyle() {
    return `width: ${this.progress}%`;
  }

  get isCitySelectDisabled() {
    return !this.formData.state;
  }

  get isGuideShopSelectDisabled() {
    return !this.formData.city;
  }

  get isNextButtonStep1Disabled() {
    return !(
      this.formData.state &&
      this.formData.city &&
      this.formData.guide_shop
    );
  }

  get isNextButtonStep2Disabled() {
    const { name, lastname, email, tel, privacyPolicy } = this.formData;
    const isTelValid = tel && tel.length === 11;

    return !(
      name &&
      lastname &&
      email &&
      this.validEmail &&
      tel &&
      isTelValid &&
      privacyPolicy
    );
  }

  get nextButtonStep1Class() {
    return `botao-proxima-etapa ${
      !this.isNextButtonStep1Disabled ? "selected" : ""
    }`;
  }

  get nextButtonStep2Class() {
    return `botao-proxima-etapa ${
      !this.isNextButtonStep2Disabled ? "selected" : ""
    }`;
  }

  connectedCallback() {
    this.initializeProgressBar();

    // Implementar o efeito sticky após o DOM ser renderizado
    Promise.resolve().then(() => {
      this.implementSticky();

      // Adicionar listener para redimensionamento da janela
      window.addEventListener("resize", this.implementSticky.bind(this));
    });
  }

  initializeProgressBar() {
    this.progress = 0;
    this.renderProgressBar();
  }

  renderProgressBar() {
    setTimeout(() => {
      if (this.currentStep !== 3) {
        const progressBarElement = this.template.querySelector(".progress-bar");
        if (progressBarElement) {
          progressBarElement.style.width = `${this.progress}%`;
        }
      }
    }, 0);
  }

  handleStateChange(event) {
    const state = event.target.value;
    this.formData.state = state;
    this.formData.city = "";
    this.formData.guide_shop = "";
    this.updateStep1Progress();

    // Reset do select de cidade e guide shop
    const citySelect = this.template.querySelector("#city");
    const guideShopSelect = this.template.querySelector("#guide_shop");

    if (citySelect) {
      // Limpar as opções existentes exceto a primeira
      while (citySelect.options.length > 1) {
        citySelect.remove(1);
      }
    }

    if (guideShopSelect) {
      while (guideShopSelect.options.length > 1) {
        guideShopSelect.remove(1);
      }
    }

    if (state) {
      const citiesByState = {
        SP: ["São Paulo", "Campinas", "Santos", "Ribeirão Preto"],
        RJ: ["Rio de Janeiro", "Niterói", "Duque de Caxias", "Nova Iguaçu"],
        MG: ["Belo Horizonte", "Uberlândia", "Contagem", "Juiz de Fora"],
        RS: ["Porto Alegre", "Caxias do Sul", "Pelotas", "Canoas"],
      };

      const cities = citiesByState[state] || ["Cidade Principal"];
      this.cityOptions = [
        { label: "Selecione", value: "", disabled: true },
        ...cities.map((city) => ({ label: city, value: city })),
      ];

      if (citySelect) {
        this.cityOptions.forEach((option, index) => {
          if (index > 0) {
            const opt = document.createElement("option");
            opt.value = option.value;
            opt.text = option.label;
            if (option.disabled) opt.disabled = true;
            citySelect.add(opt);
          }
        });
      }
    }
  }

  handleCityChange(event) {
    const city = event.target.value;
    this.formData.city = city;
    this.formData.guide_shop = "";
    this.updateStep1Progress();

    const guideShopSelect = this.template.querySelector("#guide_shop");

    if (guideShopSelect) {
      while (guideShopSelect.options.length > 1) {
        guideShopSelect.remove(1);
      }
    }

    if (city) {
      this.loadGuideShops(this.formData.state, city);
    }
  }

  loadGuideShops(state, city) {
    const guideShopsByCity = {
      "São Paulo": [
        "ABC São Paulo - Centro",
        "ABC São Paulo - Zona Sul",
        "ABC São Paulo - Zona Leste",
      ],
      Campinas: ["ABC Campinas - Centro", "ABC Campinas - Barão Geraldo"],
      "Rio de Janeiro": [
        "ABC Rio - Centro",
        "ABC Rio - Zona Sul",
        "ABC Rio - Barra",
      ],
      "Belo Horizonte": ["ABC BH - Centro", "ABC BH - Pampulha"],
      "Porto Alegre": ["ABC POA - Centro", "ABC POA - Zona Sul"],
    };

    const defaultGuideShops = ["Guide Shop Central"];
    const guideShops = guideShopsByCity[city] || defaultGuideShops;

    this.guideShopOptions = [
      { label: "Selecione", value: "", disabled: true },
      ...guideShops.map((shop) => ({ label: shop, value: shop })),
    ];

    const guideShopSelect = this.template.querySelector("#guide_shop");
    if (guideShopSelect) {
      this.guideShopOptions.forEach((option, index) => {
        if (index > 0) {
          const opt = document.createElement("option");
          opt.value = option.value;
          opt.text = option.label;
          if (option.disabled) opt.disabled = true;
          guideShopSelect.add(opt);
        }
      });
    }
  }

  handleGuideShopChange(event) {
    this.formData.guide_shop = event.target.value;
    this.updateStep1Progress();
  }

  updateStep1Progress() {
    const { state, city, guide_shop } = this.formData;
    const fields = [state, city, guide_shop];
    const filledFields = fields.filter(
      (field) => field && field.trim() !== ""
    ).length;

    this.progress = filledFields > 0 ? (filledFields / fields.length) * 90 : 0;
    this.renderProgressBar();
  }

  updateStep2Progress() {
    const { name, lastname, email, tel } = this.formData;

    const isEmailValid = this.validEmail;
    const isTelValid = tel && tel.length === 11;
    const requiredFieldsFilled =
      name && lastname && email && tel && isEmailValid && isTelValid;

    this.progress = requiredFieldsFilled ? 95 : 90;
    this.renderProgressBar();
  }

  handleNextStep() {
    if (this.currentStep < 2) {
      this.currentStep++;

      if (this.currentStep === 2) {
        this.progress = 90;
        this.renderProgressBar();
      }
    }
  }

  handlePreviousStep() {
    if (this.currentStep > 1) {
      this.currentStep--;

      if (this.currentStep === 1) {
        this.updateStep1Progress();
      } else if (this.currentStep === 2) {
        this.updateStep2Progress();
      }
    }
  }

  handleSubmitForm() {
    let name = this.formData.name;
    let firstName = name.split(" ")[0];
    let lastName =
      name.split(" ").length > 1
        ? name.replace(firstName, "").trim()
        : firstName.trim();
    let idLead = firstName.concat(
      lastName.replaceAll(" ", "").trim(),
      this.formData.tel.trim()
    );

    this.formData.idLead = idLead;
    this.formData.firstName = firstName;
    this.formData.lastName = this.formData.lastname || lastName;

    console.log("Dados que seriam enviados:", this.formData);

    this.currentStep = 3;

    this.progress = 100;
    this.renderProgressBar();
  }

  resetForm() {
    this.currentStep = 1;
    this.progress = 0;
    this.validEmail = false;
    this.formData = {
      state: "",
      city: "",
      guide_shop: "",
      name: "",
      lastname: "",
      email: "",
      tel: "",
      privacyPolicy: true,
      marketingConsent: true,
      firstName: "",
      lastName: "",
      idLead: "",
      recordtypeDevName: "Expansao",
      company: "ABC",
      company2: "ABC Expansão",
      owner: "00GbJ0000062OFjUAM",
      canalDeEntrada: "Landing Page Expansão",
    };

    this.cityOptions = [{ label: "Selecione", value: "", disabled: true }];
    this.guideShopOptions = [{ label: "Selecione", value: "", disabled: true }];

    this.renderProgressBar();
  }

  handleNameChange(event) {
    this.formData.name = event.target.value;
    this.updateStep2Progress();
  }

  handleLastnameChange(event) {
    this.formData.lastname = event.target.value;
    this.updateStep2Progress();
  }

  handleEmailChange(event) {
    const email = event.target.value;
    this.formData.email = email;

    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    this.validEmail = emailRegex.test(email);

    this.updateStep2Progress();
  }

  handleTelChange(event) {
    let value = event.target.value;

    const numericValue = value.replace(/\D/g, "");

    let formattedValue = numericValue;
    if (numericValue.length > 2) {
      formattedValue = `(${numericValue.substring(
        0,
        2
      )}) ${numericValue.substring(2)}`;
    }
    if (numericValue.length > 7) {
      formattedValue = `(${numericValue.substring(
        0,
        2
      )}) ${numericValue.substring(2, 7)}-${numericValue.substring(7, 11)}`;
    }

    event.target.value = formattedValue;

    this.formData.tel = numericValue;

    this.updateStep2Progress();
  }

  handlePrivacyPolicyChange(event) {
    this.formData.privacyPolicy = event.target.checked;
    this.updateStep2Progress();
  }

  handleMarketingConsentChange(event) {
    this.formData.marketingConsent = event.target.checked;
  }

  implementSticky() {

    const franquiaInfo = this.template.querySelector(".franquia-info");
    if (!franquiaInfo) return;


    if (window.innerWidth <= 1000) {

      franquiaInfo.style.position = "static";
      franquiaInfo.style.width = "100%";
      franquiaInfo.style.maxWidth = "100%";
      franquiaInfo.style.top = "auto";
    } else {

      franquiaInfo.style.position = "";
      franquiaInfo.style.top = "";
      franquiaInfo.style.width = "";
    }
  }
}
</script>
</body>
</html>